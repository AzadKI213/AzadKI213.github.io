---
import '../../styles/global.css';
import BlogPost from '../../layouts/BlogPost.astro';

// 加载 & 排序所有文章
const all = await Astro.glob('../../content/blog/**/*.md');
const posts = all.sort((a,b) => new Date(b.frontmatter.date) - new Date(a.frontmatter.date));

// slug 由文件名决定
const pathSlug = Astro.params.slug?.join('/') ?? '';
const post = posts.find(p => p.file.split('/').pop().replace(/\.md$/, '') === pathSlug);

if (!post) {
  return Astro.redirect((Astro.site?.pathname || '/') + '404');
}

// 生成上一篇/下一篇
const idx = posts.findIndex(p => p === post);
const prev = posts[idx - 1];
const next = posts[idx + 1];

const base = Astro.site?.pathname || '/';
const link = (p) => `${base}${p}`.replace('//','/');
---

---
<BlogPost frontmatter={post.frontmatter}>
  <post.Content />
  <hr style="border:none;border-top:1px dashed var(--stroke);margin:20px 0" />
  <div class="cta" style="justify-content:space-between">
    <div>
      {prev && <a class="btn" href={link(`blog/${prev.file.split('/').pop().replace(/\.md$/, '')}/`)}>← {prev.frontmatter.title}</a>}
    </div>
    <div>
      {next && <a class="btn" href={link(`blog/${next.file.split('/').pop().replace(/\.md$/, '')}/`)}>{next.frontmatter.title} →</a>}
    </div>
  </div>
</BlogPost>